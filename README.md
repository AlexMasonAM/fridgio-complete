#Fridgio
---

We're going to make a Rails app with Angular tied into the Rails views.

####Create a simple Angular Food Controller

app/assets/javascripts/ng-app/main.js

    angular
      .module("fridgioApp", ['ngResource'])
      .controller("foodController", foodController);

    function foodController($scope, $http, $resource) {
    }

To protect ourselves from Cross-Site Request Forgery (CSRF), we need to grab the CSRF token from the inside the `<head>` tag generated by Rails. 

Essentially, Rails _by default_ stashes a CSRF token there. We can grab the token with Jquery, then tell Angular to include it in the Header of all our requests to Rails. Rails will *only* allow API requests that include the CSRF token.

Safe and sound! :)

    angular
      .module("fridgioApp", ['ngResource'])
      // add this to the angular App module before the controller.
      .config(function($httpProvider) {
        $httpProvider.defaults.headers.common['X-CSRF-Token'] =
          $('meta[name=csrf-token]').attr('content');
      })
      // done
      .controller("foodController", foodController);

    // rest of the file

Now, let's fill out our controller with a basic Angular resource for Food:

    function foodController($scope, $http, $resource) {

      var Food = $resource('/api/food/:id', {id:'@id'});

    }

Now that we've setup a resource to RESTfully grab Food from Rails, we can add a command to fetch all the Food items while the Angular Controller is initializing.

We will also add a `console.log()` so we can see the API response in our JS console in the browser.

    function foodController($scope, $http, $resource) {

      var Food = $resource('/api/food/:id', {id:'@id'});

      Food.query(function(data){
        console.log('Fetched food!', 'Data', data);
        $scope.foods = data;
      });

    }

####Adding Functionality To The Rails/Angular View

We're going to wire this controller into the *Rails* `food#index` view.

First, let's create the FoodsController (which is different than the API controller) and add an index action:

    # app/controllers/food_controller.rb

    class FoodController < ApplicationController

      def index
        # ng-app
      end
    end


...and add a not-namespaced route for food:

    Rails.application.routes.draw do
      get "/login" => "sessions#new", as: :login
      post "/login" => "sessions#create"
      delete "/login" => "sessions#destroy", as: :logout

      resources :users
      resources :food # add this route

      namespace :api do
        resources :food
      end
    end

We can also route the root of our Rails app to the foods#index page

    root to: 'food#index'

Create a basic Rails view file for this page:

    # app/views/food/index.html.erb

    <h1>Food</h1>

Let's add a `<div>` around the title of the page and wire out controller in using the div.

    <div ng-controller="foodController">
      <h1>Food</h1>
    </div>

Now we've got all the functionality of our Angular Food Controller inside this Rails view.

Add a table and some head columns:

    <div ng-controller="foodController">
      <h1>Food</h1>

      <table>
        <thead>
          <th>Name</th>
          <th>Type</th>
          <th>Expiration</th>
        </thead>
      </table>

    </div>

...then let's add some body and use ng-repeat to repeat a silly placeholder row:
      
    ...

    <table>
      <thead>
        <th>Name</th>
        <th>Type</th>
        <th>Expiration</th>
      </thead>
      <tbody>
        <tr ng-repeat='food in foods'>
          <td>Repeat this for each food item</td>
        </tr>
      </tbody>
    </table>

    ...

Lets `rake db:seed`, then refresh this page and check that our 3 Food items are having an effect on the page. Also, check the JS Console to see the API response.

The JS console in Chrome should have something like this:

    Fetched food! Data [Resource, Resource, Resource, Resource, $promise: Promise, $resolved: true]

...and if you expand the data you can see the food we've got.

Let's add actual data, with Angular, into the table.

    ...

    <tr ng-repeat='food in foods'>
      <td>{{ food.name }}</td>
      <td>{{ food.food_type }}</td>
      <td>{{ food.expiration }}</td>
    </tr>

    ...

Awesome! But the date kind looks bad. Luckily, Angular is really good at formating those ugly, raw Unix timestamp strings. Add the date formatter to that row like this:

    <td>{{ food.expiration | date:'EEE, M/d h:mm a' }}</td>

Much better. Here are other formats, too: [Angular Date Filter](https://docs.angularjs.org/api/ng/filter/date).

####Using Rails For Some Views

Instead of writing logic in Angular for a show page, let's just use Rails. It's much easier.

    # app/controllers/food_controller.rb

    class FoodController < ApplicationController

      def index
        # ng-app
      end

      def show
        @food = Food.find(params[:id])
      end
    end

Create the view

    # app/views/food/show.html.erb

    <h1>Food Show</h1>

    <h1><%= @food.name %></h1>

    <ul>
      <li>Type: <%= @food.food_type %></li>
      <li>Expiration: <%= @food.expiration.to_formatted_s(:long) %></li>
    </ul>

And we can add links from this page to go back and forth between here and the index.

  <%= link_to "Back To All Food", food_index_path %>

####Using Angular Where It's Powerful

Let's return to the Food Index and add some powerful search. This is where Angular shines.

Add this input to the top of our index page:

    Search by name: <input type="text" ng-model="search.name">

...then add a filterto our ng-repeat:

    <td>{{ food.expiration | date:'EEE, M/d h:mm a' }}</td>

Now we can easily search our fridge.

####Bonus Activities

If we have time, we can:

* Split our list into two lists to show soon to expire food.
* Add a class to food that will expire soon.

